(require [amb [*]])
(import amb [amb [*]])

(sv
 Qdp_save  [4.926389123879079E-012  7.057033984526080E-012
            1.012110725290677E-011  1.520456506287441E-011  2.265695398276244E-011
            3.362382999149588E-011  4.956944677176232E-011  7.276570012893683E-011
            1.072863837852022E-010  1.591659348815049E-010  2.100862225222142E-010
            2.730548069323807E-010  3.459597232002530E-010  4.262929304270850E-010
            5.076390772808048E-010  5.846542177643683E-010  6.432540023938901E-010
            7.109779289456911E-010  7.541439383515314E-010  7.672873701786685E-010
            7.706665859981616E-010  7.302304727346650E-010  6.496695974295956E-010
            6.685453584942641E-010  7.207245768459882E-010  7.791022067796830E-010
            8.521103927411760E-010  9.291333282152437E-010  1.008823494321487E-009
            1.098536745586710E-009  1.194917484148587E-009  1.279853850692719E-009
            1.347434765724417E-009  1.311875484540948E-009  1.319584270385165E-009
            1.433651396586972E-009  1.560479324412998E-009  1.691919007047502E-009
            1.837790358991913E-009  1.994071278709452E-009  2.169563704083298E-009
            2.366355930711559E-009  2.588408275293107E-009  2.835573225145086E-009
            3.107237896789357E-009  3.327136386381780E-009  3.388440205423776E-009
            3.355094580652057E-009  3.243771080202440E-009  3.135040274045815E-009
            2.970303954540723E-009  2.752013508327912E-009  2.489489538059407E-009
            2.177462603304505E-009  1.839947552139290E-009  1.492762857970161E-009
            1.190271527330318E-009  1.046644678549134E-009   189665.034061307     
            291418031.367077        1123795920.08859        1517454454.85398     
            2840437840.29240        4907677766.45823        6051106653.40459     
            8277856288.47479        9488517689.02452        8802476341.33420     
            8350173597.94839        7920872479.34201        3308749346.66176     
            1396419185.25936     ]
 Qdp  [4.765081971614587E-012  7.035682518631832E-012
       1.038824280418594E-011  1.533832549620301E-011  2.264716309217118E-011
       3.343872160297833E-011  4.937254603990656E-011  7.289896819038604E-011
       1.076359229869883E-010  1.589253209593271E-010  2.087979214593209E-010
       2.729930809054176E-010  3.462834894131400E-010  4.257467089233199E-010
       5.067332422667213E-010  5.829384640921810E-010  6.467724921725472E-010
       7.078338684558028E-010  7.531491005441539E-010  7.745235984489915E-010
       7.666004487463924E-010  7.256412631222236E-010  6.501478703874560E-010
       6.680399751072875E-010  7.248136298579461E-010  7.864124292172769E-010
       8.532463391462333E-010  9.257604877954969E-010  1.004437513405045E-009
       1.089800187522974E-009  1.182416932595882E-009  1.282905528879890E-009
       1.391934885761949E-009  1.292436951854210E-009  1.312452310118615E-009
       1.423992022224296E-009  1.545011101665472E-009  1.676315228014552E-009
       1.818778455269132E-009  1.973348723294505E-009  2.141031759599105E-009
       2.322988750809915E-009  2.520410190304213E-009  2.734608256267203E-009
       2.967007084742591E-009  3.131946232645779E-009  3.142929106855169E-009
       3.102208072294954E-009  2.988073526568216E-009  2.887097802808675E-009
       2.748085934762992E-009  2.571285667449421E-009  2.357797842320167E-009
       2.109588072884192E-009  1.829475008702547E-009  1.521075181848946E-009
       1.238416973639598E-009  1.094926255338340E-009  1.069941035937074E-009
       -384.282868745222        2560607.70037418        404266150.311360     
       1334490616.12266        2087269751.28729        4452076286.80386     
       6558428882.39178        9410243953.30875        11528156981.4426     
       10834867857.4636        10479656055.8533        5416445510.52592     
       1768682990.61530     ]
 dp   [4.76508197161459        7.03568251863183     
       10.3882428041859        15.3383254962030        22.6471630921711     
       33.4387216029783        49.3725460399065        72.8989681903860     
       107.635922986988        158.925320959327        208.797921459321     
       272.993080905418        346.283489413140        425.746708923320     
       506.733242266722        582.938464092182        646.772492172548     
       707.833868455804        753.149100544154        774.523598448994     
       766.600448746392        725.641263122226        650.147870387457     
       668.039975107289        724.813629857951        786.412429217280     
       853.246339146235        925.760487795496        1004.43751340505     
       1089.80018752298        1182.41693259588        1282.90552887989     
       1391.93480742066        1292.43106261423        1312.44244926681     
       1423.98132333764        1544.99949352430        1676.30263334545     
       1818.76479023030        1973.33389692561        2141.03846940243     
       2322.99597462293        2520.41840792936        2734.61873994125     
       2967.02222279452        3131.96242191966        3142.94535290100     
       3102.23293842229        2988.11898619423        2887.14562266155     
       2748.13145211787        2571.32825640649        2357.83689522152     
       2109.62301461896        1829.50531084157        1521.10037587045     
       1238.43748590925        1094.94439092847        1070.09071267136     
       1043.52983357547        1015.28304074776        985.381222651716     
       953.860789568654        920.755072081558        886.099838186235     
       849.936575742412        812.321823411494        773.317393079488     
       732.973559332752        711.218892292658        542.152098796945     
       251.909135661150     ]
 dp_star  [4.92638912387908        7.05703398452608     
           10.1211072529068        15.2045650628744        22.6569539827624     
           33.6238299914959        49.5694467717623        72.7657001289368     
           107.286383785202        159.165934881505        210.086222522214     
           273.054806932381        345.959723200253        426.292930427085     
           507.639077280805        584.654217764369        643.254002393891     
           710.977928945691        754.143938351533        767.287370178669     
           770.666585998162        730.230472734666        649.669597429597     
           668.545358494265        720.724576845990        779.102206779686     
           852.110392741178        929.133328215245        1008.82349432149     
           1098.53674558671        1194.91748414859        1279.85385069272     
           1347.43473054448        1311.86959316583        1319.57435594880     
           1433.64062512648        1560.46760005433        1691.90629514244     
           1837.77655111084        1994.05629664610        2169.57142484434     
           2366.36323623780        2588.41679496944        2835.58440219343     
           3107.25395834064        3327.15358460896        3388.45772053584     
           3355.12990228781        3243.82480774021        3135.09220064239     
           2970.35315255386        2752.05909073776        2489.53077221509     
           2177.49866926572        1839.97802773911        1492.78758304659     
           1190.29124215263        1022.93155041302        962.872687586362     
           907.466250105007        860.837479955482        820.539823380585     
           784.087964243164        748.046259132573        710.672439698980     
           671.734685964838        632.656090269335        596.362671397627     
           562.989869145213        546.423214821213        419.689084539680     
           199.442965841533     ]
 dp1 dp_star dp2 dp
 nx 1 qsize 1
 vert_remap_q_alg 1 nlev (len dp))

(for [i (range 58)]
  (sv (get Qdp_save i) 0))
(for [i (range 58 (len Qdp_save))]
  (sv (get Qdp_save i) 1))

(defn print-f90-array [name a]
  (prfno "real(8) :: {}({:d}) = (/" name (len a))
  (sv fmt "{:22.15e} &")
  (prf fmt (first a))
  (for [i (range 1 (len a))] (prf (+ "," fmt) (get a i)))
  (prf "/)"))

(when-inp ["print"]
  (prf "nlev {}" nlev)
  (print-f90-array "dp1" dp1)
  (print-f90-array "dp2" dp2)
  (print-f90-array "Qdp" Qdp_save))

(when-inp ["plot"]
  (with [(pl-plot (, 6 9) "qdpnve")]
    (sv x (array-range 72))
    (pl.subplot 2 1 1)
    (pl.plot x dp1 "r.-" x dp2 "k.-")
    (axis-tight-pad) (my-grid)
    (pl.subplot 2 1 2)
    (pl.plot x Qdp_save "k.-" x Qdp "r.-")
    (axis-tight-pad) (my-grid)))
